<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>test2</title>
    
</head>
<body>
    <script>
        // GETパラメータを取得
        var queryString = window.location.search;
        queryString = queryString.slice(1);

        // &で切り分ける
        var parameters = queryString.split('&');

        var queryObject = {};
        for (var i = 0; i < parameters.length; i++) {
            // nameとvalueで分ける
            var element = parameters[i].split('=');

            var paramName = decodeURIComponent(element[0]);
            var paramValue = decodeURIComponent(element[1]);

            queryObject[paramName] = paramValue;
        }

        // idTokenでのプロフィール情報取得
        //verifir_id_token(queryObject['idToken']);

        // accessTokenでのプロフィール情報取得(仮)
        verifir_access_token(queryObject['accessToken']);


        function verifir_id_token(idToken){
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "https://api.line.me/oauth2/v2.1/verify", true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.onload = function () {
                var data = this.response;
                //document.write(data);
                const obj = JSON.parse(data);
                document.write(obj['sub']);
            };
            xhr.send("id_token=" + idToken + "&client_id=2002036154");
        }

        function verifir_access_token(accessToken){
            const xhr = new XMLHttpRequest();
            xhr.open("GET", "https://api.line.me/oauth2/v2.1/verify?access_token=" + accessToken, true);
            xhr.send();
            xhr.responseType = "json";
            xhr.onload = function () {
                var statusCode = this.status;
                document.write(statusCode);
                if (this.status == 200){
                    document.write("true");

                    const xhr2 = new XMLHttpRequest();
                    xhr2.open("POST", "https://api.line.me/oauth2/v2.1/userinfo", true);
                    xhr2.setRequestHeader('Authorization', 'Bearer {' + accessToken +"}");
                    xhr2.withCredentials = true;
                    xhr2.send("access_token=" + accessToken);
                    xhr2.responseType = "json";
                    xhr2.onload = function () {
                        document.write(xhr2.status);
                        document.write("data");
                        var data = this.response;
                        document.write(data);
                    }
                }else{
                    document.write("failed");
                }
                // var data = this.response;
                // document.write(data);
                // const obj = JSON.parse(data);
                //document.write(obj['sub']);
            };
            
        }

    </script>
</body>
</html>